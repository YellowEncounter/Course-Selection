<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€€è¯¾åŠŸèƒ½è°ƒè¯•æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
        }
        .section h3 {
            margin-top: 0;
            color: #333;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        
        .course-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .course-item {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .course-item.selected {
            background-color: #e7f3ff;
            border-color: #007bff;
        }
        
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        
        .timeline {
            position: relative;
            padding-left: 30px;
        }
        .timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #007bff;
        }
        .timeline-item {
            position: relative;
            margin-bottom: 20px;
            padding-left: 20px;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -7px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #007bff;
        }
    </style>
</head>
<body>
    <h1>ğŸ” é€€è¯¾åŠŸèƒ½å®Œæ•´è°ƒè¯•åˆ†æ</h1>
    
    <div class="container">
        <div class="section">
            <h3>1. é”™è¯¯å †æ ˆä¿¡æ¯</h3>
            <div id="error-stack" class="status info">
                <p>ç­‰å¾…æµ‹è¯•æ•°æ®...</p>
            </div>
        </div>
        
        <div class="section">
            <h3>2. å‰ç«¯è¯¾ç¨‹é€‰æ‹©çŠ¶æ€æ•°æ®</h3>
            <div id="frontend-data" class="status info">
                <p>æ­£åœ¨è·å–è¯¾ç¨‹æ•°æ®...</p>
            </div>
        </div>
        
        <div class="section">
            <h3>3. è¯¦ç»†å¤ç°æ­¥éª¤</h3>
            <div class="info status">
                <h4>æ ‡å‡†æ“ä½œæµç¨‹ï¼š</h4>
                <ol>
                    <li>å­¦ç”Ÿç”¨æˆ·ç™»å½•ç³»ç»Ÿï¼ˆç”¨æˆ·ID: 202501ï¼‰</li>
                    <li>è¿›å…¥"å·²é€‰è¯¾ç¨‹"æ ‡ç­¾é¡µ</li>
                    <li>æŸ¥çœ‹å·²é€‰è¯¾ç¨‹åˆ—è¡¨ï¼Œç¡®è®¤ç›®æ ‡è¯¾ç¨‹å­˜åœ¨</li>
                    <li>ç‚¹å‡»ç›®æ ‡è¯¾ç¨‹çš„"é€€é€‰"æŒ‰é’®</li>
                    <li>è§‚å¯Ÿå‰ç«¯çŠ¶æ€å˜åŒ–å’Œåç«¯å“åº”</li>
                </ol>
                
                <h4>è§¦å‘æ—¶æœºï¼š</h4>
                <ul>
                    <li>ç‚¹å‡»é€€é€‰æŒ‰é’®åç«‹å³è§¦å‘</li>
                    <li>APIè¯·æ±‚è¿”å›å“åº”åéªŒè¯</li>
                    <li>å‰ç«¯æ•°æ®æ›´æ–°åæ£€æŸ¥åŒæ­¥çŠ¶æ€</li>
                </ul>
            </div>
        </div>
        
        <div class="section">
            <h3>4. å·²é€‰è¯¾ç¨‹åˆ—è¡¨</h3>
            <div id="course-list" class="course-list">
                <p>æ­£åœ¨åŠ è½½è¯¾ç¨‹æ•°æ®...</p>
            </div>
        </div>
        
        <div class="section">
            <h3>5. APIè¯·æ±‚æµ‹è¯•</h3>
            <div>
                <label>å­¦ç”ŸIDï¼š</label>
                <input type="text" id="student-id" value="202501" placeholder="è¾“å…¥å­¦ç”ŸID">
                <label>è¯¾ç¨‹IDï¼š</label>
                <input type="text" id="course-id" value="13" placeholder="è¾“å…¥è¯¾ç¨‹ID">
                <button onclick="testDropCourse()">æµ‹è¯•é€€è¯¾API</button>
                <button onclick="testLoadCourses()">é‡æ–°åŠ è½½è¯¾ç¨‹</button>
            </div>
            <div id="api-result" class="status info">
                <p>ç­‰å¾…APIæµ‹è¯•...</p>
            </div>
        </div>
        
        <div class="section">
            <h3>6. å‰åç«¯äº¤äº’æ—¶åºå›¾</h3>
            <div class="timeline" id="timeline">
                <div class="timeline-item">
                    <strong>å‰ç«¯äº‹ä»¶è§¦å‘</strong>
                    <p>ç”¨æˆ·ç‚¹å‡»é€€é€‰æŒ‰é’®</p>
                </div>
                <!-- æ›´å¤šæ—¶åºé¡¹ç›®å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
            </div>
        </div>
        
        <div class="section">
            <h3>7. é—®é¢˜æ ¹æºåˆ†æ</h3>
            <div id="root-cause" class="status info">
                <p>ç­‰å¾…æ•°æ®åˆ†æ...</p>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let coursesData = [];
        let userInfo = { id: '202501', name: 'æµ‹è¯•å­¦ç”Ÿ' };
        
        // æ¨¡æ‹ŸAPIè¯·æ±‚
        async function apiRequest(url, method = 'GET', data = null) {
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                }
            };
            
            if (data) {
                options.body = JSON.stringify(data);
            }
            
            try {
                const response = await fetch(`http://localhost:3000${url}`, options);
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('APIè¯·æ±‚å¤±è´¥:', error);
                throw error;
            }
        }
        
        // åŠ è½½è¯¾ç¨‹æ•°æ®
        async function loadCourses() {
            addTimelineItem('å¼€å§‹åŠ è½½è¯¾ç¨‹æ•°æ®', 'å‰ç«¯');
            
            try {
                // æ¨¡æ‹Ÿè¯¾ç¨‹æ•°æ®ï¼ˆå®é™…åº”è¯¥ä»APIè·å–ï¼‰
                coursesData = [
                    {
                        id: 13,
                        name: 'æµ‹è¯•è¯¾ç¨‹_å¼ è€å¸ˆ',
                        credit: 3,
                        time: 'å‘¨ä¸€ 8:00-10:00',
                        description: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•è¯¾ç¨‹',
                        maxStudents: 30,
                        teacherId: 1001,
                        teacherName: 'å¼ è€å¸ˆ',
                        students: ['202501', '202502']  // æµ‹è¯•æ•°æ®
                    },
                    {
                        id: 14,
                        name: 'æµ‹è¯•è¯¾ç¨‹_æˆ´è€å¸ˆ',
                        credit: 2,
                        time: 'å‘¨ä¸‰ 14:00-16:00',
                        description: 'è¿™æ˜¯å¦ä¸€ä¸ªæµ‹è¯•è¯¾ç¨‹',
                        maxStudents: 25,
                        teacherId: 1002,
                        teacherName: 'æˆ´è€å¸ˆ',
                        students: ['202501']
                    }
                ];
                
                displayCourses();
                updateFrontendData();
                addTimelineItem('è¯¾ç¨‹æ•°æ®åŠ è½½å®Œæˆ', 'å‰ç«¯');
                
            } catch (error) {
                document.getElementById('course-list').innerHTML = 
                    `<div class="error status">åŠ è½½å¤±è´¥: ${error.message}</div>`;
                addTimelineItem('è¯¾ç¨‹æ•°æ®åŠ è½½å¤±è´¥', 'å‰ç«¯', error.message);
            }
        }
        
        // æ˜¾ç¤ºè¯¾ç¨‹åˆ—è¡¨
        function displayCourses() {
            const container = document.getElementById('course-list');
            const selectedCourses = coursesData.filter(course => 
                course.students && course.students.includes(userInfo.id)
            );
            
            if (selectedCourses.length === 0) {
                container.innerHTML = '<div class="warning status">æš‚æ— å·²é€‰è¯¾ç¨‹</div>';
                return;
            }
            
            container.innerHTML = selectedCourses.map(course => `
                <div class="course-item selected">
                    <h4>${course.name}</h4>
                    <p><strong>è¯¾ç¨‹ID:</strong> ${course.id}</p>
                    <p><strong>æ•™å¸ˆ:</strong> ${course.teacherName}</p>
                    <p><strong>æ—¶é—´:</strong> ${course.time}</p>
                    <p><strong>å­¦åˆ†:</strong> ${course.credit}</p>
                    <p><strong>å½“å‰å­¦ç”Ÿ:</strong> [${course.students.join(', ')}]</p>
                    <button onclick="testDropCourseWithId(${course.id})" style="background-color: #dc3545;">
                        é€€é€‰è¯¾ç¨‹
                    </button>
                </div>
            `).join('');
        }
        
        // æ›´æ–°å‰ç«¯æ•°æ®æ˜¾ç¤º
        function updateFrontendData() {
            const frontendDiv = document.getElementById('frontend-data');
            const selectedCourses = coursesData.filter(course => 
                course.students && course.students.includes(userInfo.id)
            );
            
            frontendDiv.innerHTML = `
                <div class="success status">
                    <h4>å½“å‰çŠ¶æ€ï¼š</h4>
                    <p><strong>ç”¨æˆ·ID:</strong> ${userInfo.id}</p>
                    <p><strong>ç”¨æˆ·å:</strong> ${userInfo.name}</p>
                    <p><strong>æ€»è¯¾ç¨‹æ•°:</strong> ${coursesData.length}</p>
                    <p><strong>å·²é€‰è¯¾ç¨‹æ•°:</strong> ${selectedCourses.length}</p>
                    <p><strong>å·²é€‰è¯¾ç¨‹:</strong></p>
                    <ul>
                        ${selectedCourses.map(c => `<li>${c.name} (ID:${c.id})</li>`).join('')}
                    </ul>
                </div>
            `;
        }
        
        // æµ‹è¯•é€€è¯¾API
        async function testDropCourse() {
            const studentId = document.getElementById('student-id').value;
            const courseId = document.getElementById('course-id').value;
            testDropCourseWithId(courseId, studentId);
        }
        
        async function testDropCourseWithId(courseId, studentId = null) {
            const sid = studentId || userInfo.id;
            const resultDiv = document.getElementById('api-result');
            
            // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
            resultDiv.innerHTML = '<div class="info status">æ­£åœ¨æµ‹è¯•é€€è¯¾API...</div>';
            
            addTimelineItem('å‘èµ·é€€è¯¾è¯·æ±‚', 'å‰ç«¯', `è¯¾ç¨‹ID: ${courseId}, å­¦ç”ŸID: ${sid}`);
            
            try {
                // æ„é€ è¯·æ±‚æ•°æ®
                const requestData = {
                    courseId: parseInt(courseId),
                    studentId: parseInt(sid)
                };
                
                addTimelineItem('å‘é€APIè¯·æ±‚', 'å‰ç«¯', JSON.stringify(requestData));
                
                // æ¨¡æ‹ŸAPIè°ƒç”¨ï¼ˆè¿™é‡Œéœ€è¦çœŸå®çš„åç«¯APIï¼‰
                const response = await apiRequest('/api/pbl/dropCourse', 'POST', requestData);
                
                addTimelineItem('æ”¶åˆ°APIå“åº”', 'åç«¯', JSON.stringify(response));
                
                // æ˜¾ç¤ºè¯¦ç»†ç»“æœ
                displayApiResult(response, requestData);
                
                // åˆ†æç»“æœ
                analyzeApiResponse(response, requestData);
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error status">
                        <h4>APIè¯·æ±‚å¤±è´¥</h4>
                        <p><strong>é”™è¯¯ä¿¡æ¯:</strong> ${error.message}</p>
                        <pre>${error.stack || 'æ— å †æ ˆä¿¡æ¯'}</pre>
                    </div>
                `;
                addTimelineItem('APIè¯·æ±‚å¤±è´¥', 'å‰ç«¯', error.message);
                updateRootCause('å‰ç«¯APIè¯·æ±‚å¤±è´¥', error.message);
            }
        }
        
        // æ˜¾ç¤ºAPIç»“æœ
        function displayApiResult(response, requestData) {
            const resultDiv = document.getElementById('api-result');
            
            resultDiv.innerHTML = `
                <div class="${response.success ? 'success' : 'error'} status">
                    <h4>APIå“åº”ç»“æœï¼š</h4>
                    <p><strong>æˆåŠŸçŠ¶æ€:</strong> ${response.success}</p>
                    <p><strong>æ¶ˆæ¯:</strong> ${response.message || response.error || 'æ— æ¶ˆæ¯'}</p>
                    <p><strong>é”™è¯¯ç :</strong> ${response.code || 'æ— é”™è¯¯ç '}</p>
                    <p><strong>è¯·æ±‚å‚æ•°:</strong></p>
                    <pre>${JSON.stringify(requestData, null, 2)}</pre>
                    <p><strong>å®Œæ•´å“åº”:</strong></p>
                    <pre>${JSON.stringify(response, null, 2)}</pre>
                </div>
            `;
        }
        
        // åˆ†æAPIå“åº”
        function analyzeApiResponse(response, requestData) {
            const courseId = requestData.courseId;
            const studentId = requestData.studentId;
            
            // æ£€æŸ¥è¯¾ç¨‹å­˜åœ¨æ€§
            const course = coursesData.find(c => c.id === courseId);
            if (!course) {
                updateRootCause('è¯¾ç¨‹ä¸å­˜åœ¨', `è¯¾ç¨‹ID ${courseId} åœ¨å‰ç«¯æ•°æ®ä¸­ä¸å­˜åœ¨`);
                return;
            }
            
            // æ£€æŸ¥å­¦ç”Ÿæ˜¯å¦åœ¨è¯¾ç¨‹ä¸­
            const isInCourse = course.students && course.students.includes(String(studentId));
            
            if (!isInCourse) {
                updateRootCause('å‰ç«¯çŠ¶æ€ä¸ä¸€è‡´', 
                    `å­¦ç”ŸID ${studentId} åœ¨è¯¾ç¨‹ ${course.name} ä¸­ä¸å­˜åœ¨ï¼Œä½†å‰ç«¯ä»æ˜¾ç¤ºä¸ºå·²é€‰çŠ¶æ€`);
                return;
            }
            
            // æ£€æŸ¥APIå“åº”
            if (!response.success && response.error && response.error.includes('æœªé€‰æ‹©')) {
                updateRootCause('åç«¯éªŒè¯é€»è¾‘é—®é¢˜', 
                    'å‰ç«¯è®¤ä¸ºå­¦ç”Ÿåœ¨è¯¾ç¨‹ä¸­ï¼Œä½†åç«¯éªŒè¯å¤±è´¥');
            } else if (response.success) {
                updateRootCause('æµ‹è¯•æˆåŠŸ', 'é€€è¯¾æ“ä½œæ‰§è¡ŒæˆåŠŸ');
            }
        }
        
        // æ·»åŠ æ—¶åºå›¾é¡¹ç›®
        function addTimelineItem(action, source, details = '') {
            const timeline = document.getElementById('timeline');
            const item = document.createElement('div');
            item.className = 'timeline-item';
            item.innerHTML = `
                <strong>${action}</strong>
                <p>æ¥æº: ${source}${details ? `<br>è¯¦æƒ…: ${details}` : ''}</p>
                <small>${new Date().toLocaleTimeString()}</small>
            `;
            timeline.appendChild(item);
        }
        
        // æ›´æ–°é—®é¢˜æ ¹æºåˆ†æ
        function updateRootCause(issue, details) {
            const rootDiv = document.getElementById('root-cause');
            
            let analysis = '';
            let solution = '';
            
            switch(issue) {
                case 'è¯¾ç¨‹ä¸å­˜åœ¨':
                    analysis = 'å‰ç«¯å°è¯•é€€é€‰ä¸€ä¸ªä¸å­˜åœ¨çš„è¯¾ç¨‹';
                    solution = 'æ£€æŸ¥è¯¾ç¨‹æ•°æ®åŠ è½½é€»è¾‘ï¼Œç¡®ä¿è¯¾ç¨‹IDæ­£ç¡®';
                    break;
                    
                case 'å‰ç«¯çŠ¶æ€ä¸ä¸€è‡´':
                    analysis = 'å‰ç«¯æ˜¾ç¤ºå­¦ç”Ÿå·²é€‰è¯¾ç¨‹ï¼Œä½†å®é™…æ•°æ®ä¸­ä¸å­˜åœ¨';
                    solution = 'ä¿®å¤å‰ç«¯çŠ¶æ€ç®¡ç†é€»è¾‘ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§';
                    break;
                    
                case 'åç«¯éªŒè¯é€»è¾‘é—®é¢˜':
                    analysis = 'åç«¯å­˜å‚¨è¿‡ç¨‹éªŒè¯é€»è¾‘æœ‰ç¼ºé™·ï¼Œæ— æ³•æ­£ç¡®è¯†åˆ«å­¦ç”Ÿ';
                    solution = 'ä¿®å¤åç«¯å­˜å‚¨è¿‡ç¨‹çš„JSONæ“ä½œé€»è¾‘';
                    break;
                    
                case 'æµ‹è¯•æˆåŠŸ':
                    analysis = 'é€€è¯¾åŠŸèƒ½æ­£å¸¸å·¥ä½œ';
                    solution = 'æ— éœ€ä¿®å¤';
                    break;
                    
                default:
                    analysis = 'æœªçŸ¥é—®é¢˜';
                    solution = 'éœ€è¦è¿›ä¸€æ­¥è°ƒæŸ¥';
            }
            
            rootDiv.innerHTML = `
                <div class="warning status">
                    <h4>é—®é¢˜æ ¹æºï¼š${issue}</h4>
                    <p><strong>åˆ†æï¼š</strong> ${analysis}</p>
                    <p><strong>è¯¦æƒ…ï¼š</strong> ${details}</p>
                    <p><strong>å»ºè®®ä¿®å¤æ–¹æ¡ˆï¼š</strong> ${solution}</p>
                </div>
            `;
        }
        
        // æµ‹è¯•åŠ è½½è¯¾ç¨‹
        function testLoadCourses() {
            loadCourses();
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            loadCourses();
        };
    </script>
</body>
</html>